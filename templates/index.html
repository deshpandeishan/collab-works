<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>CollabWorks</title>
        <link rel="icon" type="image/png" href="{{ url_for('static', filename='img/logo/collabWorks.ico') }}">
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
        <link rel="stylesheet" href="{{ url_for('static', filename='css/index/index.css') }}">
        <link rel='stylesheet' href='https://cdn-uicons.flaticon.com/2.6.0/uicons-bold-straight/css/uicons-bold-straight.css'>
        <link rel='stylesheet' href='https://cdn-uicons.flaticon.com/2.6.0/uicons-bold-rounded/css/uicons-bold-rounded.css'>        
    </head>
    <body>
        {% include 'header/header.html' %}

        <div class="cta-section">
            <img id="upper-mockup" src="{{ url_for('static', filename='img/cta/upperside.png') }}" alt="Mockup" class="mockup">


            <div class="line-section">
                <p>
                <span id="firstline" class="cta-line">Find talent</span><br>
                <span id="secondline" class="cta-line">for your next project</span>
                </p>
                
            </div>

            <button id="cta-btn" class="btn">Get Started <i class="fi fi-bs-arrow-up-right"></i></button>
            <img id="bottom-mockup" src="{{ url_for('static', filename='img/cta/bottomside.png') }}" alt="Mockup" class="mockup">
        </div>

        <div class="mobile-cta-section">
            <img id="mobile-upper-mockup" src="{{ url_for('static', filename='img/cta/mobile-upperside.png') }}" alt="Mockup" class="mockup">
            <div class="mobile-line-section">
                <p>
                    <span id="mobile-firstline" class="cta-line">Find talent</span><br>
                    <span id="mobile-secondline" class="cta-line">for your next project</span>
                </p>
            <button id="cta-btn" class="btn">Get Started <i class="fi fi-bs-arrow-up-right"></i></button>

            </div>
            <img id="mobile-bottom-mockup" src="{{ url_for('static', filename='img/cta/mobile-bottomside.png') }}" alt="Mockup" class="mockup">
        </div>        



        <div id="search-section" class="search-section">

            <span id="search-firstline">Describe your need or</span><br>
            <span id="search-secondline">search by role</span>

            <div class="search-bar-wrapper">
                <div class="search-input-wrapper">
                    <input id="search-bar" class="search-bar" type="text" placeholder="What do you want to build?">
                    <span class="shortcut-hint">⌘ + K</span>
                    <button id="search-icon" class="btn" style="display: none;"><i class="fa-solid fa-arrow-up"></i></button>
                </div>
            </div>
            
            <p id="search-instruction">We use Natural Language Processing to understand your request to show results.</p>

            <div id="filter-sort-section" class="filter-sort-section">
                <div class="sort-wrapper">
                    <label for="sort-select">Sort by:</label>
                    <select id="sort-select">
                        <option value="rating-desc">Highest Rating</option>
                        <option value="rating-asc">Lowest Rating</option>
                    </select>
                </div>

                <div class="filter-wrapper">
                    <label for="role-filter">Role:</label>
                    <select id="role-filter">
                        <option value="all">All</option>
                    </select>
            
                    <label for="price-filter">Location:</label>
                    <select id="price-filter">
                        <option value="all">All</option>
                        <option value="rate-asc">Lowest Rate</option>
                        <option value="rate-desc">Highest Rate</option>
                    </select>
                </div>
            
                <button id="apply-filters-btn" class="btn">Apply</button>
            </div>
            
            <div id="no-results-container" style="display:none; text-align:center; margin-top:30px;">
                <div id="no-results-animation" style="width:250px; height:250px; margin:0 auto;"></div>
                <p id="no-results-text" style="font-size:1.2rem; color:#555; margin-top:10px;">
                  Oops! We couldn’t find any matching roles.<br>
                  Try rephrasing your need statement.
                </p>
            </div>
              
            <div id="search-results" class="search-results"></div>

        </div>

        
        <div class="info-section">
            <img class="pc-image" id="info-image" src="{{ url_for('static', filename='img/info-section/pc.jpg') }}" alt="People Working" class="info-img">
            <img class="mobile-image" id="info-image" src="{{ url_for('static', filename='img/info-section/mobile.jpg') }}" alt="People Working" class="info-img">
            <div class="info-text-container">
                <p id="left-side" class="info-text">WHERE IDEAS TALK</p>
                <p id="right-side" class="info-text">AND BUILDERS LISTEN</p>
            </div>
        </div>

        <div class="clients-feedback-section">
            <h1 id="clients-feedback-section-heading">Loved by <br>agencies and their clients</h1>

            <div class="clients-logo-section">
                <img src="{{ url_for('static', filename='img/clients-logo/out-brand-them.png') }}" alt="Agency 1" class="logo">
                <img src="{{ url_for('static', filename='img/clients-logo/pro-narrative.png') }}" alt="Agency 2" class="logo">
                <img src="{{ url_for('static', filename='img/clients-logo/ply.png') }}" alt="Agency 3" class="logo">
                <img src="{{ url_for('static', filename='img/clients-logo/tsd.png') }}" alt="Agency 4" class="logo">
                <img src="{{ url_for('static', filename='img/clients-logo/like-noa.png') }}" alt="Agency 5" class="logo">
            </div>
        </div>

        {% include 'footer/footer.html' %}

        <script>
            window.addEventListener("DOMContentLoaded", () => {
                document.querySelectorAll(".cta-line").forEach((el, i) => {
                    el.style.animationDelay = `${i * 0.3}s`;
                    el.classList.add("animate");
                });

                document.getElementById("cta-btn").classList.add("animate");

                document.getElementById("upper-mockup").classList.add("animate");
                document.getElementById("bottom-mockup").classList.add("animate");
            });

            window.addEventListener("DOMContentLoaded", () => {
            document.querySelectorAll(".cta-line").forEach((el, i) => {
                el.style.animationDelay = `${i * 0.3}s`;
                el.classList.add("animate");
            });

            document.getElementById("cta-btn").classList.add("animate");
            });

            const searchSection = document.getElementById("search-section");

            const observer = new IntersectionObserver(
            (entries, observer) => {
                entries.forEach(entry => {
                if (entry.isIntersecting) {
                    searchSection.classList.add("animate");
                    observer.unobserve(searchSection);
                }
                });
            },
            { threshold: 0.3 }
            );

            observer.observe(searchSection);

            function detectOS() {
                const userAgent = window.navigator.userAgent;
                if (userAgent.indexOf('Mac') !== -1) {
                    return 'mac';
                } else if (userAgent.indexOf('Win') !== -1 || userAgent.indexOf('Linux') !== -1) {
                    return 'windows';
                }
                return 'other';
            }

            function updateShortcut() {
                const os = detectOS();
                const shortcutHint = document.querySelector('.shortcut-hint');
                const searchBar = document.getElementById('search-bar');

                if (!shortcutHint || !searchBar) return;

                const defaultHint = os === 'mac' ? '⌘ + k' : 'Ctrl + k';
                shortcutHint.textContent = defaultHint;

                searchBar.addEventListener('focus', () => {
                    shortcutHint.textContent = '↵ Enter';
                });

                searchBar.addEventListener('blur', () => {
                    shortcutHint.textContent = defaultHint;
                });
            }

            document.getElementById('cta-btn').addEventListener('click', function(event) {
                event.preventDefault();
                document.querySelector('.search-section').scrollIntoView({ behavior: 'smooth' });
            });

            function setupKeyboardShortcut() {
                document.addEventListener('keydown', function(event) {
                    const isCmd = (event.metaKey && event.key === 'k');
                    const isCtrl = (event.ctrlKey && event.key === 'k');

                    if (isCmd || isCtrl) {
                        event.preventDefault();
                        const searchBar = document.getElementById('search-bar');
                        searchBar.focus();
                    }

                    if (event.key === 'Escape') {
                        const searchBar = document.getElementById('search-bar');
                        searchBar.blur();
                    }
                });
            }

            const searchBar = document.getElementById("search-bar");
            const searchIcon = document.getElementById("search-icon");

            async function triggerSearch() {
                const needStatement = searchBar.value.trim();
                if (!needStatement) return;

                document.getElementById("no-results-container").style.display = "none";

                const resultsDiv = document.getElementById("search-results");
                resultsDiv.innerHTML = `
                    <div id="searching-container" class="searching-wrapper">
                        <div id="searching-animation" style="width: 250px; height: 250px; margin: auto;"></div>
                        <p style="text-align:center; font-weight:500; color:#555;">Finding best freelancers for you...</p>
                    </div>
                `;

                lottie.loadAnimation({
                    container: document.getElementById("searching-animation"),
                    renderer: "svg",
                    loop: true,
                    autoplay: true,
                    path: "/static/animations/searching.json"
                });


                searchBar.scrollIntoView({ behavior: "smooth", block: "start" });

                try {
                    const response = await fetch("/predict_roles", {
                        method: "POST",
                        headers: { "Content-Type": "application/x-www-form-urlencoded" },
                        body: new URLSearchParams({ "need_statement": needStatement, "top_n": 4 })
                    });
                    const data = await response.json();

                    resultsDiv.innerHTML = "";

                    const rolesResponse = await fetch("/get_roles");
                    let roles = [];
                    if (rolesResponse.ok) {
                        const rolesData = await rolesResponse.json();
                        const latest = rolesData[rolesData.length - 1];
                        roles = latest.roles;
                    }

                    const profilesResponse = await fetch("/get_freelancers");
                    if (profilesResponse.ok) {
                        let profiles = await profilesResponse.json();

                        profiles.sort((a, b) => b.rating - a.rating);

                        profiles.forEach(profile => {
                            createCard(profile, roles);
                        });
                    } else {
                        resultsDiv.innerHTML = "";
                        document.getElementById("no-results-container").style.display = "block";

                        lottie.loadAnimation({
                            container: document.getElementById("no-results-animation"),
                            renderer: "svg",
                            loop: true,
                            autoplay: true,
                            path: "/static/animations/non data found.json"
                        });
                    }

                } catch (err) {
                    console.error(err);
                    resultsDiv.innerHTML = "";
                    document.getElementById("no-results-container").style.display = "block";

                    lottie.loadAnimation({
                        container: document.getElementById("no-results-animation"),
                        renderer: "svg",
                        loop: true,
                        autoplay: true,
                        path: "/static/animations/non data found.json"
                    });
                }
            }


            searchBar.addEventListener("keypress", (event) => {
                if (event.key === "Enter") {
                    triggerSearch();
                }
            });

            searchIcon.addEventListener("click", () => {
                triggerSearch();
            });



            function createCard(data, roles) {
                const card = document.createElement("div");
                card.className = "card";

                const cardData = document.createElement("div");
                cardData.id = "card-data";

                const img = document.createElement("img");
                img.src = data.image;
                img.alt = "User pfp";
                img.className = "result-image";

                const nameTitle = document.createElement("div");
                nameTitle.className = "name-title";

                const name = document.createElement("span");
                name.id = "name";
                name.textContent = data.name;

                // const role = document.createElement("span");
                // role.id = "role";
                // role.textContent = data.role;

                const tagline = document.createElement("span");
                tagline.id = "tagline";
                tagline.textContent = data.tagline;

                const extraInfo = document.createElement("div");
                extraInfo.className = "extra-info";

                const location = document.createElement("span");
                location.className = "location";
                location.textContent = data.location;

                const rate = document.createElement("span");
                rate.className = "rate";
                rate.textContent = data.rate;

                extraInfo.append(location, rate);

                const skillsDiv = document.createElement("div");
                skillsDiv.className = "skills";
                roles.forEach(roleName => {
                    const skillTag = document.createElement("span");
                    skillTag.className = "skill-tag";
                    skillTag.textContent = roleName;
                    skillsDiv.appendChild(skillTag);
                });

                nameTitle.append(name, tagline, extraInfo, skillsDiv);
                cardData.append(img, nameTitle);

                const bottomWrapper = document.createElement("div");
                bottomWrapper.className = "bottom-wrapper";

                const workBtn = document.createElement("button");
                workBtn.id = "work-btn";
                workBtn.className = "btn";
                workBtn.textContent = "Choose to work";

                workBtn.addEventListener("click", async () => {
                    try {
                        const response = await fetch("/check_client_status");
                        const statusData = await response.json();

                        if (statusData.status === "ok") {
                            window.location.href = `/start_chat/${data.unique_id}`;
                        } else {
                            alert("Please log in as a Client to choose a freelancer.");
                            window.location.href = "/client/login";
                        }
                    } catch (err) {
                        console.error(err);
                        alert("Error checking login status. Try again.");
                    }
                });
                console.log(data);


                const ratingWrapper = document.createElement("div");
                ratingWrapper.className = "rating-wrapper";
                ratingWrapper.title = `Based on ${data.ratingCount} reviews`;

                const ratingIcon = document.createElement("img");
                ratingIcon.src = data.ratingIcon;
                ratingIcon.alt = "Rating Icon";
                ratingIcon.id = "rating-icon";
                ratingIcon.className = "rating-icon";

                const rateSpan = document.createElement("span");
                rateSpan.id = "rate";
                rateSpan.textContent = data.rating;

                const ratingCount = document.createElement("span");
                ratingCount.id = "rating-count";
                ratingCount.textContent = `(${data.ratingCount})`;

                ratingWrapper.append(ratingIcon, rateSpan, ratingCount);
                bottomWrapper.append(workBtn, ratingWrapper);
                

                card.append(cardData, bottomWrapper);
                card.style.animationDelay = `${document.querySelectorAll(".card").length * 0.1}s`;
                document.getElementById("search-results").appendChild(card);
            }


            // let allProfiles = [];

            // async function triggerSearch() {
            //     const needStatement = searchBar.value.trim();
            //     if (!needStatement) return;

            //     const resultsDiv = document.getElementById("search-results");
            //     resultsDiv.innerHTML = `<div class="searching-wrapper"><video src="/static/img/searching/searching.mp4" autoplay muted loop></video></div>`;
            //     searchBar.scrollIntoView({ behavior: "smooth", block: "start" });

            //     try {
            //         const response = await fetch("/predict_roles", {
            //             method: "POST",
            //             headers: { "Content-Type": "application/x-www-form-urlencoded" },
            //             body: new URLSearchParams({ "need_statement": needStatement, "top_n": 4 })
            //         });
            //         const data = await response.json();

            //         const rolesResponse = await fetch("/get_roles");
            //         let roles = [];
            //         if (rolesResponse.ok) {
            //             const rolesData = await rolesResponse.json();
            //             const latest = rolesData[rolesData.length - 1];
            //             roles = latest.roles;
            //         }

            //         const profilesResponse = await fetch("/get_freelancers");
            //         if (profilesResponse.ok) {
            //             allProfiles = await profilesResponse.json();
            //             renderProfiles(allProfiles, roles.length ? roles : ["Developer"]);
            //             populateFilters(allProfiles);
            //         } else {
            //             resultsDiv.innerHTML = "<p>Error fetching profiles from DB.</p>";
            //         }
            //     } catch (err) {
            //         console.error(err);
            //         resultsDiv.innerHTML = "<p>Error fetching results.</p>";
            //     }
            // }

            // // Render cards after sorting/filtering
            // function renderProfiles(profiles, roles) {
            //     const resultsDiv = document.getElementById("search-results");
            //     resultsDiv.innerHTML = "";
            //     profiles.forEach(profile => createCard(profile, roles));
            // }

            // // Populate Role & Location filters dynamically
            // function populateFilters(profiles) {
            //     const roleSet = new Set();
            //     const locationSet = new Set();

            //     profiles.forEach(p => {
            //         roleSet.add(p.role);
            //         locationSet.add(p.location);
            //     });

            //     const roleFilter = document.getElementById("role-filter");
            //     const locationFilter = document.getElementById("location-filter");

            //     roleFilter.innerHTML = `<option value="all">All</option>`;
            //     locationFilter.innerHTML = `<option value="all">All</option>`;

            //     roleSet.forEach(r => roleFilter.innerHTML += `<option value="${r}">${r}</option>`);
            //     locationSet.forEach(l => locationFilter.innerHTML += `<option value="${l}">${l}</option>`);
            // }

            // // Apply filters & sorting
            // document.getElementById("apply-filters-btn").addEventListener("click", () => {
            //     const roleVal = document.getElementById("role-filter").value;
            //     const locationVal = document.getElementById("location-filter").value;
            //     const ratingVal = parseFloat(document.getElementById("rating-filter").value);
            //     const sortVal = document.getElementById("sort-select").value;

            //     let filtered = allProfiles.filter(p => 
            //         (roleVal === "all" || p.role === roleVal) &&
            //         (locationVal === "all" || p.location === locationVal) &&
            //         (p.rating >= ratingVal)
            //     );

            //     switch(sortVal) {
            //         case "rating-desc": filtered.sort((a,b) => b.rating - a.rating); break;
            //         case "rating-asc": filtered.sort((a,b) => a.rating - b.rating); break;
            //         case "rate-desc": filtered.sort((a,b) => parseFloat(b.rate) - parseFloat(a.rate)); break;
            //         case "rate-asc": filtered.sort((a,b) => parseFloat(a.rate) - parseFloat(b.rate)); break;
            //         case "reviews-desc": filtered.sort((a,b) => b.ratingCount - a.ratingCount); break;
            //         case "reviews-asc": filtered.sort((a,b) => a.ratingCount - b.ratingCount); break;
            //     }

            //     const roles = []; // We can pass empty roles or maintain the previous role array
            //     renderProfiles(filtered, roles);
            // });


            updateShortcut();
            setupKeyboardShortcut();

            document.addEventListener('DOMContentLoaded', function () {
                const observer = new IntersectionObserver((entries) => {
                    entries.forEach(entry => {
                        if (entry.isIntersecting) {
                            document.getElementById('left-side').classList.add('fade-in-left');
                            document.getElementById('right-side').classList.add('fade-in-right');
                            observer.disconnect();
                        }
                    });
                }, { threshold: 0.5 });

                const target = document.querySelector('.info-section');
                if (target) observer.observe(target);

                const feedbackSection = document.querySelector('.clients-feedback-section');
                const feedbackObserver = new IntersectionObserver((entries) => {
                    entries.forEach(entry => {
                        if (entry.isIntersecting) {
                            feedbackSection.classList.add('fade-in');
                            feedbackObserver.disconnect();
                        }
                    });
                }, { threshold: 0.5 });

                const feedbackTarget = document.querySelector('.clients-logo-section');
                if (feedbackTarget) feedbackObserver.observe(feedbackTarget);
            });

        </script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/lottie-web/5.10.1/lottie.min.js"></script>
    </body>
</html>
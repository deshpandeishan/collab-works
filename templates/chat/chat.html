<!doctype html>
<html lang="en">
    <head>
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width,initial-scale=1" />
        <title>Chat App</title>
        <link rel="stylesheet" href="{{ url_for('static', filename='css/chat/style.css') }}" />
        <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.7.2/socket.io.min.js" integrity="sha512-5/E+4Ft8Q6DNK20+pAguHZZYZ8vADl+V34Zd0kHrCqVxS3bUw1y0ZJw5fFz7AnHz0G2Ljz+2Rg8gks6Pq3F3hQ==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    </head>
    <body>
        <div class="app">
            <aside class="sidebar">
                <div class="sidebar-top">
                    <div class="page-title">Messages</div>
                    <div class="search">
                        <input id="searchInput" placeholder="Search or start new chat" />
                    </div>
                </div>
                <div class="conversations" id="conversationsList">
                    {% for c in conversations %}
                        <div class="conversation-item {% if c.id == active_id %}active{% endif %}" data-id="{{ c.id }}">
                            <img class="avatar" src="{{ c.avatar }}" alt="avatar" />
                            <div class="meta">
                                <div class="row">
                                    <div class="name">{{ c.name }}</div>
                                    <div class="time">{{ c.timestamp }}</div>
                                </div>
                                <div class="last">{{ c.last_message }}</div>
                            </div>
                        </div>
                    {% endfor %}
                </div>
            </aside>

            <main class="chat-area">
                <header class="chat-header" id="chatHeader">
                    <div class="left">
                        {% if conversations and conversations|length > 0 %}
                            <img id="headerAvatar" class="avatar-lg" src="{{ conversations[0].avatar }}" alt="">
                            <div id="headerName">{{ conversations[0].name }}</div>
                            <div id="headerStatus">{{ conversations[0].last_seen }}</div>
                        {% else %}
                            <p>No conversations available.</p>
                        {% endif %}
                    </div>
                </header>

                <section class="messages" id="messages">
                    {% if conversations and conversations|length > 0 and conversations[0].messages %}
                        {% for msg in conversations[0].messages %}
                            <div class="message {% if msg.from_me %}me{% else %}them{% endif %}">
                                <div class="bubble">
                                    <div class="text">{{ msg.text }}</div>
                                    <div class="msg-time">{{ msg.time }}</div>
                                </div>
                            </div>
                        {% endfor %}
                    {% else %}
                        <p>No messages yet.</p>
                    {% endif %}
                </section>

                <footer class="composer">
                  <div class="attachments">
                    <i class="fa-solid fa-paperclip"></i>
                    <i class="fa-regular fa-image"></i>
                    <i class="fa-regular fa-face-smile"></i>

                  </div>
                    <input id="messageBox" placeholder="Type your message here..." autocomplete="off" />
                    <button id="sendBtn" class="send">Send</button>
                </footer>
            </main>
        </div>

        <script>
            const convListEl = document.getElementById("conversationsList");
            const messagesEl = document.getElementById("messages");
            const headerName = document.getElementById("headerName");
            const headerAvatar = document.getElementById("headerAvatar");
            const headerStatus = document.getElementById("headerStatus");
            const messageBox = document.getElementById("messageBox");
            const sendBtn = document.getElementById("sendBtn");
            const searchInput = document.getElementById("searchInput");

            const currentUser = "{{ user }}";
            let activeId = {{ active_id }};
            let initialConversations = {{ conversations|tojson|safe }};

            function escapeHtml(unsafe){
                return String(unsafe).replace(/[&<"'>]/g, m => {
                    return {'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":"&#039;"}[m];
                });
            }

            function formatMessage(msg){
                const wrap = document.createElement("div");
                const isMe = msg.from_me && msg.user == currentUser;
                wrap.className = "message " + (isMe ? "me" : "them");
                const bubble = document.createElement("div");
                bubble.className = "bubble";
                bubble.innerHTML = `<div class="text">${escapeHtml(msg.text)}</div><div class="msg-time">${msg.time}</div>`;
                wrap.appendChild(bubble);
                return wrap;
            }

            function getReceiverUniqueId(convId){
                const conv = initialConversations.find(c => c.id === convId);
                return conv ? conv.unique_id : null;
            }

            function renderConversations(list){
                convListEl.innerHTML = "";
                list.forEach(c => {
                    const div = document.createElement("div");
                    div.className = "conversation-item" + (c.id === activeId ? " active" : "");
                    div.dataset.id = c.id;
                    div.innerHTML = `
                        <img class="avatar" src="${c.avatar}" />
                        <div class="meta">
                            <div class="row">
                                <div class="name">${escapeHtml(c.name)}</div>
                                <div class="time">${escapeHtml(c.timestamp || "")}</div>
                            </div>
                            <div class="last">${escapeHtml(c.last_message || "")}</div>
                        </div>
                    `;
                    div.addEventListener("click", () => loadConversation(c.id));
                    convListEl.appendChild(div);
                });
            }

            function loadConversation(id){
                if (!id) return;
                fetch(`/chat/${id}`)
                    .then(r => r.json())
                    .then(conv => {
                        activeId = conv.id;
                        headerName.textContent = conv.name;
                        if(conv.avatar) headerAvatar.src = conv.avatar;
                        headerStatus.textContent = conv.last_seen;
                        messagesEl.innerHTML = "";
                        (conv.messages || []).forEach(m => messagesEl.appendChild(formatMessage(m)));
                        document.querySelectorAll(".conversation-item").forEach(el => el.classList.remove("active"));
                        const activeEl = document.querySelector(`.conversation-item[data-id='${id}']`);
                        if(activeEl) activeEl.classList.add("active");
                        messagesEl.scrollTop = messagesEl.scrollHeight;
                    });
            }

            function sendMessage(){
                const text = messageBox.value.trim();
                if(!text) return;
                const receiverId = getReceiverUniqueId(activeId);
                if(!receiverId) return;

                fetch("/send", {
                    method: "POST",
                    headers: {"Content-Type":"application/json"},
                    body: JSON.stringify({conv_id: activeId, text, user: currentUser, receiver_id: receiverId})
                })
                .then(r => r.json())
                .then(res => {
                    if(res.status === "ok"){
                        messagesEl.appendChild(formatMessage(res.message));
                        messagesEl.scrollTop = messagesEl.scrollHeight;
                        messageBox.value = "";
                        updateConversationPreview(activeId, res.message.text, res.message.time);
                    }
                });
            }

            function updateConversationPreview(id, lastText, time){
                const el = document.querySelector(`.conversation-item[data-id='${id}']`);
                if(el){
                    const last = el.querySelector(".last");
                    const t = el.querySelector(".time");
                    if(last) last.textContent = lastText;
                    if(t) t.textContent = time;
                }
                const conv = initialConversations.find(c => c.id === id);
                if(conv){
                    conv.last_message = lastText;
                    conv.timestamp = time;
                }
            }

            searchInput.addEventListener("input", () => {
                const q = searchInput.value.trim().toLowerCase();
                renderConversations(initialConversations.filter(c =>
                    (c.name || "").toLowerCase().includes(q) || (c.last_message || "").toLowerCase().includes(q)
                ));
            });

            sendBtn.addEventListener("click", sendMessage);
            messageBox.addEventListener("keydown", e => {
                if(e.key === "Enter" && !e.shiftKey){
                    e.preventDefault();
                    sendMessage();
                }
            });

            setInterval(() => {
                if(activeId) loadConversation(activeId);
            }, 2000);

            renderConversations(initialConversations);
            loadConversation(activeId);
            messagesEl.scrollTop = messagesEl.scrollHeight;
        </script>
        <script src="/socket.io/socket.io.js"></script>
    </body>
</html>
